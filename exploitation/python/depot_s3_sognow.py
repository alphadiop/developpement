# -*- coding: utf-8 -*-
###################################################################################################################
#                       Dépôt S3 de la donnée SOGNOW                                                              #
###################################################################################################################

import os
import sys

from path import Path


src_path = os.path.join(os.path.dirname(Path(os.path.abspath(__file__)).parent.parent), 'script')
print(src_path)
for rep in os.listdir(src_path):
    sys.path.append(os.path.join(src_path, rep))

from chargement_s3_sognow import ChargementS3Sognow
from sql_connexion import get_sql_operations
from time_periodes import get_mois
from time_periodes import get_semaines
from read_parameters import read_parameters

if __name__ == '__main__':
    # parameters = "{'Periodicite': 'hebdo', 'PeriodeDebut': '202053', 'PeriodeFin': '202105'}"
    parameters = read_parameters(sys.argv)

    periode_debut, periode_fin = parameters.pop('PeriodeDebut'), parameters.pop('PeriodeFin')
    sql_operations = get_sql_operations()
    periodes = (get_semaines(sql_operations, periode_debut, periode_fin) if parameters['Periodicite'] == 'hebdo'
                else get_mois(sql_operations, periode_debut, periode_fin))

    parameters.update(dict(Moteur='sognow', Table='sognow'))
    print('')
    print(f"Moteur    : {parameters['Moteur']}")
    print(f"Periodicite: {parameters['Periodicite']}")
    print('Periodes   : ' + ", ".join(periodes))
    print('')
    for periode in periodes:
        print(f'    Periode: {periode}', end=',')
        parameters['Periode'] = periode
        chargement = ChargementS3Sognow(parameters)
        chargement.run()
