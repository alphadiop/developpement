# -*- coding: utf-8 -*-
###################################################################################################################
#            Chargement des donn√©es sur un serveur SQL                                                            #
###################################################################################################################

import os
import sys

from path import Path

src_path = os.path.join(os.path.dirname(Path(os.path.abspath(__file__)).parent.parent), 'script')
for rep in os.listdir(src_path):
    sys.path.append(os.path.join(src_path, rep))

from chargement_dw import ChargementDW
from sql_connexion import get_sql_operations
from time_periodes import get_semaines
from time_periodes import get_mois
from read_parameters import read_parameters

if __name__ == '__main__':
    # parameters = {'Moteur': 'pmgtg', 'Table': 'pmgtg', 'Periodicite': 'hebdo', 'PeriodeDebut': '201601', 'PeriodeFin': '202152', }

    parameters = read_parameters(sys.argv)

    moteur, table, periodicite = parameters['Moteur'], parameters['Table'], parameters['Periodicite']
    periode_debut, periode_fin = parameters['PeriodeDebut'], parameters['PeriodeFin']

    sql_operations = get_sql_operations()
    periodes = (get_semaines(sql_operations, periode_debut, periode_fin) if periodicite == 'hebdo'
                else get_mois(sql_operations, periode_debut, periode_fin))

    print('')
    print('Moteur     : ' + moteur)
    print('Table      : ' + table)
    print('Periodicite: ' + periodicite)
    print('Periodes   : ' + ", ".join(periodes))
    print('')
    for periode in periodes:
        print('    Periode: {0}'.format(periode), end=',')
        ChargementDW(dict(Moteur=moteur, Table=table, Periodicite=periodicite, Periode=periode)).run()
