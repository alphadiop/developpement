# -*- coding: utf-8 -*-
from moteurs_stat import get_table_name
from sql_connexion import get_sql_operations
from sql_schema import get_columns_from_schema
from sql_schema import get_schema_from_json
from time_periodes import get_cle_periode
from time_periodes import get_semaines


class CopySqlServer:

    def __init__(self, table: str, periodicite: str, src_table: str, periodes: dict):
        self.table = table
        self.periodicite = periodicite
        self.src_table = src_table
        self.periodes = periodes

    def __str__(self):
        pass

    def run(self):
        sql_operations = get_sql_operations()

        schema = get_schema_from_json(self.table, self.periodicite, logger=None)
        columns = get_columns_from_schema(schema, logger=None)

        dst_table = get_table_name(self.table, self.periodicite, logger=None)
        periodes = get_semaines(sql_operations, self.periodes['Start'], self.periodes['End'])
        print('Periodes à copier: {0} à {1}'.format(periodes[0], periodes[1]))

        for periode in periodes:
            print('Periode: {0}'.format(periode))
            condition_src_table = 'WHERE {ClePeriode} = {Periode}'.format(ClePeriode=get_cle_periode(self.periodicite),
                                                                          Periode=periode)
            sql_operations.insert_into_select(self.src_table, dst_table, columns,
                                              condition_src_table=condition_src_table)


if __name__ == '__main__':
    CopySqlServer('sig_relocalise', 'hebdo', '[PEB4GERSISQL06].[DW_GersIt].[sog].[FaitSemaineVentesUgaSog]',
                  {'Start': 201918, 'End': 201918}).run()






